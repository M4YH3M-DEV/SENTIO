# GitHub Actions CI Pipeline for SENTIO
# Runs on every push and pull request
# Tests ROS packages, Python code, Node.js UI, and firmware

name: CI Pipeline

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'sentio_ros2_ws/**'
      - 'ui/**'
      - 'sentio/firmware/**'
      - 'sentio/tools/**'
      - '.github/workflows/ci.yml'
      - 'pyproject.toml'
      - 'setup.cfg'
  pull_request:
    branches: [ main, develop ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: '3.12'
  NODE_VERSION: '20'
  ROS_DISTRO: 'rolling'
  UBUNTU_VERSION: '24.04'

jobs:
  # ============================================================================
  # Python Code Quality & Unit Tests
  # ============================================================================
  python-quality:
    name: Python Quality (Lint & Format)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install linting tools
        run: |
          python -m pip install --upgrade pip
          pip install black flake8 isort mypy pylint
      
      - name: Black format check
        run: black --check sentio_ros2_ws/ ui/ sentio/tools/
        continue-on-error: true
      
      - name: isort import check
        run: isort --check-only sentio_ros2_ws/ ui/ sentio/tools/
        continue-on-error: true
      
      - name: Flake8 linting
        run: flake8 sentio_ros2_ws/ ui/ sentio/tools/ --max-line-length=100 --ignore=E203,W503
        continue-on-error: true
      
      - name: MyPy type checking
        run: mypy sentio_ros2_ws/ --ignore-missing-imports
        continue-on-error: true

  python-tests:
    name: Python Unit Tests (pytest)
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: [ '3.10', '3.11', '3.12' ]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov pytest-xdist pyyaml
      
      - name: Run pytest on sentio_core
        run: |
          cd sentio_ros2_ws/src/sentio_core
          pytest tests/ -v --cov=sentio_core --cov-report=xml
        continue-on-error: true
      
      - name: Run pytest on sentio_perception
        run: |
          cd sentio_ros2_ws/src/sentio_perception
          pytest tests/ -v --cov=sentio_perception --cov-report=xml
        continue-on-error: true
      
      - name: Run pytest on sentio_fusion
        run: |
          cd sentio_ros2_ws/src/sentio_fusion
          pytest tests/ -v --cov=sentio_fusion --cov-report=xml
        continue-on-error: true
      
      - name: Run pytest on sentio_policy
        run: |
          cd sentio_ros2_ws/src/sentio_policy
          pytest tests/ -v --cov=sentio_policy --cov-report=xml
        continue-on-error: true
      
      - name: Run pytest on sentio_motion
        run: |
          cd sentio_ros2_ws/src/sentio_motion
          pytest tests/ -v --cov=sentio_motion --cov-report=xml
        continue-on-error: true
      
      - name: Run pytest on sentio_demo
        run: |
          cd sentio_ros2_ws/src/sentio_demo
          pytest tests/ -v --cov=sentio_demo --cov-report=xml
        continue-on-error: true
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          fail_ci_if_error: false
        continue-on-error: true

  # ============================================================================
  # ROS 2 Build & Package Tests
  # ============================================================================
  ros2-build:
    name: ROS 2 Package Build
    runs-on: ubuntu-latest
    container:
      image: ros:rolling-ros-core-jammy
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup ROS 2 environment
        run: |
          apt-get update
          apt-get install -y \
            python3-pip \
            python3-colcon-common-extensions \
            python3-rosdep \
            git
      
      - name: Install dependencies
        run: |
          cd sentio_ros2_ws
          rosdep init || true
          rosdep update
          rosdep install --from-paths src --ignore-src -y || true
      
      - name: Build ROS 2 packages with colcon
        run: |
          cd sentio_ros2_ws
          source /opt/ros/rolling/setup.bash
          colcon build \
            --symlink-install \
            --event-handlers console_direct+ \
            --cmake-args -DCMAKE_BUILD_TYPE=Release
      
      - name: Run ROS 2 package tests
        run: |
          cd sentio_ros2_ws
          source /opt/ros/rolling/setup.bash
          source install/setup.bash
          colcon test \
            --event-handlers console_direct+ \
            --return-code-on-failure

  # ============================================================================
  # Node.js UI Tests
  # ============================================================================
  ui-quality:
    name: UI Code Quality (ESLint & Prettier)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'ui/package-lock.json'
      
      - name: Install UI dependencies
        run: |
          cd ui
          npm ci
      
      - name: ESLint check
        run: |
          cd ui
          npm run lint
        continue-on-error: true
      
      - name: Prettier format check
        run: |
          cd ui
          npm run format -- --check
        continue-on-error: true
      
      - name: TypeScript type check
        run: |
          cd ui
          npm run type-check
        continue-on-error: true

  ui-tests:
    name: UI Unit Tests
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [ '18', '20', '22' ]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: 'ui/package-lock.json'
      
      - name: Install UI dependencies
        run: |
          cd ui
          npm ci
      
      - name: Run Jest tests
        run: |
          cd ui
          npm test -- --coverage --watchAll=false
        continue-on-error: true
      
      - name: Build UI for production
        run: |
          cd ui
          npm run build
      
      - name: Upload UI build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: ui-build-${{ matrix.node-version }}
          path: ui/.next
          retention-days: 7
        continue-on-error: true

  # ============================================================================
  # Firmware Build
  # ============================================================================
  firmware-build:
    name: Firmware Build (PlatformIO)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install PlatformIO
        run: |
          python -m pip install --upgrade pip
          pip install platformio
      
      - name: Build firmware (ESP32)
        run: |
          cd sentio/firmware/esp32_servo_bridge
          platformio run -e esp32doit-devkit-v1
      
      - name: Build firmware (ESP32 production)
        run: |
          cd sentio/firmware/esp32_servo_bridge
          platformio run -e esp32doit-devkit-v1-prod
      
      - name: Upload firmware artifacts
        uses: actions/upload-artifact@v3
        with:
          name: firmware-builds
          path: sentio/firmware/esp32_servo_bridge/.pio/build/
          retention-days: 7

  # ============================================================================
  # Integration Tests (Headless)
  # ============================================================================
  integration-tests:
    name: Integration Tests (Headless)
    runs-on: ubuntu-latest
    container:
      image: ros:rolling-ros-core-jammy
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup test environment
        run: |
          apt-get update
          apt-get install -y \
            python3-pip \
            python3-colcon-common-extensions \
            python3-rosdep \
            git \
            xvfb
      
      - name: Build ROS packages
        run: |
          cd sentio_ros2_ws
          source /opt/ros/rolling/setup.bash
          colcon build --symlink-install
      
      - name: Run integration tests
        run: |
          cd sentio_ros2_ws
          source /opt/ros/rolling/setup.bash
          source install/setup.bash
          colcon test --packages-select sentio_core
        env:
          DISPLAY: ':99'

  # ============================================================================
  # Documentation Build
  # ============================================================================
  docs:
    name: Build Documentation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install doc tools
        run: |
          python -m pip install --upgrade pip
          pip install sphinx sphinx-rtd-theme
      
      - name: Build docs
        run: |
          cd docs
          make clean html
        continue-on-error: true
      
      - name: Upload docs artifacts
        uses: actions/upload-artifact@v3
        with:
          name: documentation
          path: docs/_build/html/
          retention-days: 30
        continue-on-error: true

  # ============================================================================
  # Security Scanning (Optional)
  # ============================================================================
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run Bandit security check
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install Bandit
        run: pip install bandit
      
      - name: Scan Python code
        run: |
          bandit -r sentio_ros2_ws/ --skip B101,B601 -f json -o bandit-report.json
        continue-on-error: true
      
      - name: Upload security report
        uses: actions/upload-artifact@v3
        with:
          name: security-report
          path: bandit-report.json
          retention-days: 30
        continue-on-error: true

  # ============================================================================
  # Final Status Check
  # ============================================================================
  status-check:
    name: Status Check
    runs-on: ubuntu-latest
    needs: [python-quality, python-tests, ros2-build, ui-quality, ui-tests, firmware-build]
    if: always()
    
    steps:
      - name: Check job statuses
        run: |
          if [ "${{ needs.python-quality.result }}" != "success" ] && [ "${{ needs.python-quality.result }}" != "skipped" ]; then
            echo "Python quality check failed"
          fi
          
          if [ "${{ needs.ros2-build.result }}" == "failure" ]; then
            echo "ROS 2 build failed"
            exit 1
          fi
          
          if [ "${{ needs.ui-tests.result }}" == "failure" ]; then
            echo "UI tests failed"
            exit 1
          fi
          
          echo "All critical checks passed"

