# CI/CD Pipeline Documentation

Complete guide to SENTIO's Continuous Integration and Deployment infrastructure.

## Overview

### GitHub Actions Workflows

| Workflow | Trigger | Purpose |
|----------|---------|---------|
| `ci.yml` | Push/PR to main/develop | Test code quality, build, unit tests |
| `release.yml` | Tag push (v*.*.*)| Build & publish release artifacts |
| `firmware-build.yml` | Firmware files change | Build firmware for multiple boards |
| `ui-build.yml` | UI files change | Build and test Next.js UI |

### CI Dashboard

- Status badge: See README.md
- Detailed logs: GitHub Actions tab
- Artifacts: Downloadable from workflow page

## Running CI Locally

### Prerequisites

Install required tools
pip install pytest pytest-cov black flake8 isort mypy
npm install -g eslint prettier

Install ROS 2 (if not already done)
source /opt/ros/rolling/setup.bash

text

### Quick CI Run

cd sentio

Run everything (what CI runs)
./ci/test-runner.sh

Expected output:
✓ Python linting
✓ Python type checking
✓ Python unit tests
✓ ROS 2 build
✓ ROS 2 tests
✓ UI linting
✓ UI tests
✓ Firmware build
text

### Individual Checks

Python formatting check
black --check sentio_ros2_ws/ ui/ sentio/tools/

Python linting
flake8 sentio_ros2_ws/ ui/ sentio/tools/

Python type checking
mypy sentio_ros2_ws/ --ignore-missing-imports

Python tests
pytest sentio_ros2_ws/src -v --cov

ROS 2 build
cd sentio_ros2_ws
colcon build --symlink-install

ROS 2 tests
colcon test

UI linting
cd ui && npm run lint && cd ..

UI tests
cd ui && npm test -- --coverage && cd ..

Firmware build
cd sentio/firmware/esp32_servo_bridge
platformio run -e esp32doit-devkit-v1-prod

text

## GitHub Actions Secrets

Secrets are used for sensitive credentials (GitHub token, deployment keys, etc.).

### Available Secrets

| Secret | Purpose | Set By |
|--------|---------|--------|
| `GITHUB_TOKEN` | Auto-generated by GitHub | GitHub |
| `DEPLOY_KEY` | SSH key for deployment | Repository admin |
| `DOCKER_USERNAME` | Docker Hub auth | Repository admin |
| `DOCKER_PASSWORD` | Docker Hub auth | Repository admin |

### Using Secrets in Workflows

name: Deploy
env:
DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}
run: |
echo "$DEPLOY_KEY" > key.pem
chmod 600 key.pem

Use key for deployment
text

### Adding New Secrets

1. Go to GitHub repo settings
2. Secrets → Actions → New repository secret
3. Enter name and value
4. Use in workflows with `${{ secrets.NAME }}`

## Workflow Configurations

### Python Version Matrix

strategy:
matrix:
python-version: ['3.10', '3.11', '3.12']

text

Tests run on all 3 versions. Failures on any version fail the job.

### Node Version Matrix

strategy:
matrix:
node-version: [18.x, 20.x, 22.x]

text

### OS Matrix (if needed)

strategy:
matrix:
os: [ubuntu-latest, macos-latest, windows-latest]

text

## Artifact Handling

### Upload Artifacts

name: Upload build
uses: actions/upload-artifact@v3
with:
name: ui-build-${{ matrix.node-version }}
path: ui/.next/
retention-days: 30

text

- `name`: Artifact identifier
- `path`: Files to upload
- `retention-days`: Keep for N days (then auto-delete)

### Download Artifacts

name: Download build
uses: actions/download-artifact@v3
with:
name: ui-build-20.x
path: ./artifact/

text

## Caching for Speed

### Cache pip dependencies

name: Set up Python
uses: actions/setup-python@v4
with:
python-version: '3.12'
cache: 'pip' # Automatic cache key

text

### Cache npm dependencies

name: Set up Node
uses: actions/setup-node@v3
with:
node-version: '20'
cache: 'npm' # Automatic cache key
cache-dependency-path: 'ui/package-lock.json'

text

### Manual cache

name: Cache downloads
uses: actions/cache@v3
with:
path: ~/.cache/pip
key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
restore-keys: |
${{ runner.os }}-pip-

text

## Branch Protection Rules

Protect main branch from accidental merges:

1. Go to repo Settings → Branches
2. Add rule for `main`
3. Require:
   - [ ] Pull request review (1 approver)
   - [ ] Status checks pass (ci.yml)
   - [ ] Branches up to date before merging
   - [ ] Code owners reviewed

## Troubleshooting

### CI Failures

**Issue**: Test fails on CI but passes locally

**Solutions**:
1. Check Python version: `python3 --version`
2. Check dependencies: `pip list`
3. Clear caches: GitHub Actions → Clear cache
4. Re-run job: "Re-run jobs" button

**Issue**: "Actions not enabled"

**Solution**: 
1. Go to repo Settings → Actions
2. Select "Allow all actions and reusable workflows"
3. Click Save

**Issue**: Timeout (job runs > 6 hours)

**Solutions**:
1. Optimize test speed (parallel with `-n auto`)
2. Split into multiple jobs
3. Remove expensive tests from CI

### Docker Issues

**Issue**: "docker: command not found"

**Solution**: Use `docker://` in `container` section:

container:
image: ubuntu:24.04

text

**Issue**: Slow Docker pulls

**Solution**: Add caching:

name: Set up Docker Buildx
uses: docker/setup-buildx-action@v2
with:
driver-options: cache=true

text

## Performance Optimization

### Parallel Jobs

jobs:
python-tests:
runs-on: ubuntu-latest

ui-tests:
runs-on: ubuntu-latest
# Runs in parallel with python-tests

text

Both jobs run simultaneously (if runners available).

### Job Dependencies

needs: [python-tests, ui-tests]

This job only runs after the two above complete
text

### Conditional Steps

name: Deploy (main only)
if: github.ref == 'refs/heads/main'
run: ./deploy.sh

text

## Notifications

### PR Status Checks

- Comments added automatically on PR
- Shows which checks passed/failed
- Direct link to failed job logs

### Slack Notifications (optional)

name: Notify Slack
if: failure()
uses: slackapi/slack-github-action@v1
with:
webhook-url: ${{ secrets.SLACK_WEBHOOK }}

text

## Best Practices

✅ **Do**:
- Cache dependencies
- Run tests in parallel
- Fail fast (quick checks first)
- Use matrix for version testing
- Upload artifacts for inspection
- Add meaningful step names
- Comment workflows with why things are done

❌ **Don't**:
- Sleep/wait in workflows
- Download large files unnecessarily
- Run slow integration tests on every PR
- Commit artifacts to git
- Store secrets in code

## Release Process

### Tagging a Release

Create annotated tag
git tag -a v1.2.3 -m "Release v1.2.3 - New features"

Push tag
git push origin v1.2.3

text

### What Happens Automatically

1. GitHub Actions detects tag
2. Runs `release.yml` workflow
3. Builds firmware, UI, docs
4. Creates GitHub Release page
5. Uploads artifacts
6. Publishes Docker images (if configured)

### Manual Release (if CI fails)

Download artifacts from CI
Create release manually on GitHub
Upload artifacts manually
Or run release locally:
./ci/release.sh v1.2.3

text

## Monitoring & Debugging

### View Logs

1. Go to repo → Actions tab
2. Click workflow run
3. Click job
4. Expand step to see full output

### Debug Mode

Enable debug logging:

name: Enable debug logging
run: |
echo "ACTIONS_STEP_DEBUG=true" >> $GITHUB_ENV

text

Logs will include variable values and step execution details.

### Measure Performance

1. Each step shows duration at the end
2. Note which steps are slowest
3. Focus optimization there

## Advanced Topics

### Docker-based Runners

For complex test environments (e.g., ROS 2):

container:
image: ros:rolling-ros-core-jammy
options: --cpus 4 --memory 8g

text

### Matrix with Exclude

strategy:
matrix:
os: [ubuntu-latest, macos-latest, windows-latest]
python-version: [3.10, 3.11, 3.12]
exclude:
- os: windows-latest
python-version: 3.10 # Skip this combination

text

### Reusable Workflows

Create `.github/workflows/test.yml` once, use in multiple places:

jobs:
test:
uses: ./.github/workflows/test.yml
with:
python-version: '3.12'

text

## Support

- **Documentation**: GitHub Actions docs
- **Issues**: GitHub Issues with `ci` label
- **Email**: dev@devsora.tech

---

**Last Updated**: 2025-11-13